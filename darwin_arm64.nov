// ---------------------------------------------------------------------------
// env/darwin_arm64 - environment utilities for macOS Apple Silicon
// ---------------------------------------------------------------------------

module env_darwin_arm64;

import ../std;
import ../process;

// ---------------------------------------------------------------------------
// Get current working directory via __getcwd syscall
// ---------------------------------------------------------------------------

fn getcwd() -> str {
    let buf: str = make_buffer(1024);
    mov(x0, buf);
    mov(x1, 1024);
    mov(x16, 0x2000130);  // SYS___getcwd = 304
    syscall();
    let result: str = "";
    let i: i32 = 0;
    while (i < 1024) {
        let b: i32 = buf[i] & 255;
        if (b == 0) { break; }
        result = result + buf[i];
        i = i + 1;
    }
    return result;
}

// ---------------------------------------------------------------------------
// Get process ID
// ---------------------------------------------------------------------------

fn getpid() -> i32 {
    mov(x16, 0x2000014);  // SYS_getpid = 20
    syscall();
    return u64_to_i32(getreg(x0));
}

// ---------------------------------------------------------------------------
// Get parent process ID
// ---------------------------------------------------------------------------

fn getppid() -> i32 {
    mov(x16, 0x2000027);  // SYS_getppid = 39
    syscall();
    return u64_to_i32(getreg(x0));
}

// ---------------------------------------------------------------------------
// Get user ID
// ---------------------------------------------------------------------------

fn getuid() -> i32 {
    mov(x16, 0x2000018);  // SYS_getuid = 24
    syscall();
    return u64_to_i32(getreg(x0));
}

// ---------------------------------------------------------------------------
// Get effective user ID
// ---------------------------------------------------------------------------

fn geteuid() -> i32 {
    mov(x16, 0x2000019);  // SYS_geteuid = 25
    syscall();
    return u64_to_i32(getreg(x0));
}

// ---------------------------------------------------------------------------
// Get environment variable value via printenv (no raw environ access)
// ---------------------------------------------------------------------------

fn getenv(name: str) -> str {
    let a0: str = "/usr/bin/printenv";
    let av: []u64 = [ptr(a0), ptr(name), 0];
    return capture_output(a0, av, 4096);
}

// ---------------------------------------------------------------------------
// Get hostname
// ---------------------------------------------------------------------------

fn gethostname() -> str {
    let a0: str = "/bin/hostname";
    let av: []u64 = [ptr(a0), 0];
    return capture_output(a0, av, 256);
}

// ---------------------------------------------------------------------------
// Get home directory
// ---------------------------------------------------------------------------

fn get_home_dir() -> str {
    return getenv("HOME");
}

// ---------------------------------------------------------------------------
// Get username
// ---------------------------------------------------------------------------

fn get_username() -> str {
    return getenv("USER");
}

// ---------------------------------------------------------------------------
// Get OS name
// ---------------------------------------------------------------------------

fn get_os_name() -> str {
    let a0: str = "/usr/bin/uname";
    let a1: str = "-s";
    let av: []u64 = [ptr(a0), ptr(a1), 0];
    return capture_output(a0, av, 128);
}

// ---------------------------------------------------------------------------
// Get OS version
// ---------------------------------------------------------------------------

fn get_os_version() -> str {
    let a0: str = "/usr/bin/uname";
    let a1: str = "-r";
    let av: []u64 = [ptr(a0), ptr(a1), 0];
    return capture_output(a0, av, 128);
}

// ---------------------------------------------------------------------------
// Get machine architecture
// ---------------------------------------------------------------------------

fn get_arch() -> str {
    let a0: str = "/usr/bin/uname";
    let a1: str = "-m";
    let av: []u64 = [ptr(a0), ptr(a1), 0];
    return capture_output(a0, av, 128);
}
