// ---------------------------------------------------------------------------
// env/linux_amd64 - environment utilities for Linux x86_64
// ---------------------------------------------------------------------------

module env_linux_amd64;

import ../std;
import ../process;

// ---------------------------------------------------------------------------
// Get current working directory via getcwd syscall
// ---------------------------------------------------------------------------

fn getcwd() -> str {
    let buf: str = make_buffer(1024);
    mov(rax, 79);      // SYS_getcwd
    mov(rdi, buf);
    mov(rsi, 1024);
    syscall();
    let result: str = "";
    let i: i32 = 0;
    while (i < 1024) {
        let b: i32 = buf[i] & 255;
        if (b == 0) { break; }
        result = result + buf[i];
        i = i + 1;
    }
    return result;
}

// ---------------------------------------------------------------------------
// Get process ID
// ---------------------------------------------------------------------------

fn getpid() -> i32 {
    mov(rax, 39);      // SYS_getpid
    syscall();
    return u64_to_i32(getreg(rax));
}

// ---------------------------------------------------------------------------
// Get parent process ID
// ---------------------------------------------------------------------------

fn getppid() -> i32 {
    mov(rax, 110);     // SYS_getppid
    syscall();
    return u64_to_i32(getreg(rax));
}

// ---------------------------------------------------------------------------
// Get user ID
// ---------------------------------------------------------------------------

fn getuid() -> i32 {
    mov(rax, 102);     // SYS_getuid
    syscall();
    return u64_to_i32(getreg(rax));
}

// ---------------------------------------------------------------------------
// Get effective user ID
// ---------------------------------------------------------------------------

fn geteuid() -> i32 {
    mov(rax, 107);     // SYS_geteuid
    syscall();
    return u64_to_i32(getreg(rax));
}

// ---------------------------------------------------------------------------
// Get environment variable value via printenv
// ---------------------------------------------------------------------------

fn getenv(name: str) -> str {
    let a0: str = "/usr/bin/printenv";
    let av: []u64 = [ptr(a0), ptr(name), 0];
    return capture_output(a0, av, 4096);
}

// ---------------------------------------------------------------------------
// Get hostname
// ---------------------------------------------------------------------------

fn gethostname() -> str {
    let a0: str = "/bin/hostname";
    let av: []u64 = [ptr(a0), 0];
    return capture_output(a0, av, 256);
}

// ---------------------------------------------------------------------------
// Get home directory
// ---------------------------------------------------------------------------

fn get_home_dir() -> str {
    return getenv("HOME");
}

// ---------------------------------------------------------------------------
// Get username
// ---------------------------------------------------------------------------

fn get_username() -> str {
    return getenv("USER");
}

// ---------------------------------------------------------------------------
// Get OS name
// ---------------------------------------------------------------------------

fn get_os_name() -> str {
    let a0: str = "/usr/bin/uname";
    let a1: str = "-s";
    let av: []u64 = [ptr(a0), ptr(a1), 0];
    return capture_output(a0, av, 128);
}

// ---------------------------------------------------------------------------
// Get OS version
// ---------------------------------------------------------------------------

fn get_os_version() -> str {
    let a0: str = "/usr/bin/uname";
    let a1: str = "-r";
    let av: []u64 = [ptr(a0), ptr(a1), 0];
    return capture_output(a0, av, 128);
}

// ---------------------------------------------------------------------------
// Get machine architecture
// ---------------------------------------------------------------------------

fn get_arch() -> str {
    let a0: str = "/usr/bin/uname";
    let a1: str = "-m";
    let av: []u64 = [ptr(a0), ptr(a1), 0];
    return capture_output(a0, av, 128);
}
